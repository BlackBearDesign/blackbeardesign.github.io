<script>
let projectsData = [];

document.addEventListener('DOMContentLoaded', function() {
  // Tu link de Excel dinámico
  const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9yghObfHQDI1wcM1g4gn2uMOSSd_w-qYkS1TFHAJXsnJDA-zi8A_4X9ymMGhtreM7f0sY8JRGqnBE/pub?gid=0&single=true&output=csv"; 

  Papa.parse(URL_CSV, {
    download: true,
    header: true,
    complete: function(results) {
      projectsData = results.data.filter(i => i.ID && i.Titulo);
      
      // ALEATORIO: Mezcla todos los videos cada vez que cargues
      projectsData.sort(() => Math.random() - 0.5);

      let htmlGrid = "";
      projectsData.forEach(item => {
        // Mantenemos las clases EXACTAS para la distribución de 3 columnas
        htmlGrid += `
          <div class="item col-sm-6 col-md-6 col-lg-4 isotope-mb-2">
            <a href="javascript:void(0)" class="portfolio-item isotope-item gsap-reveal-img" onclick="loadDynamicProject('${item.ID}')">
              <div class="overlay">
                <span class="wrap-icon icon-play_circle_filled"></span>
                <div class="portfolio-item-content">
                  <h3>${item.Titulo}</h3>
                  <p>${item.Cliente}</p>
                </div>
              </div>
              <img src="${item.ThumbnailURL}" class="img-fluid" alt="${item.Titulo}" style="width:100%; height:250px; object-fit:cover;">
            </a>
          </div>`;
      });
      document.getElementById('posts').innerHTML = htmlGrid;
    }
  });
});

// Lógica de desvanecimiento y apertura (Estilo Modern Building)
function loadDynamicProject(id) {
  const p = projectsData.find(item => item.ID == id);
  const holder = document.getElementById('portfolio-single-holder');
  const wrapper = document.querySelector('.portfolio-wrapper');
  let vidId = p.VideoURL.split('v=')[1] || p.VideoURL.split('/').pop();

  // 1. Desvanecer cuadrícula
  wrapper.style.display = 'none';

  // 2. Montar Ficha Técnica Lateral (Description, Date, Client)
  holder.innerHTML = `
    <div class="container" style="padding-top: 50px;">
      <div class="row justify-content-between mb-5">
        <div class="col-12 d-flex justify-content-between align-items-center mb-4">
           <h2 class="heading-h2" style="margin:0; color:white; font-size: 2.5rem;">${p.Titulo}</h2>
           <div class="close-portfolio-item" onclick="closeDynamicProject()" style="cursor:pointer; background:rgba(255,255,255,0.1); width:45px; height:45px; display:flex; align-items:center; justify-content:center; border-radius:50%;">
             <span class="wrap-icon icon-close2" style="font-size:24px; color:white;"></span>
           </div>
        </div>
        <div class="col-md-8">
          <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; background:#000; border-radius:4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <iframe src="https://www.youtube.com/embed/${vidId}?autoplay=1" style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;" allow="autoplay; fullscreen" allowfullscreen></iframe>
          </div>
        </div>
        <div class="col-md-3 text-white">
          <div class="project-detail-item mb-4">
            <h4 style="color:#888; text-transform:uppercase; font-size:11px; letter-spacing:2px; font-weight:700; margin-bottom:10px;">Project Description</h4>
            <p style="font-size:14px; color:#ccc; line-height:1.6;">${p.Descripcion}</p>
          </div>
          <div class="project-detail-item mb-4">
            <h4 style="color:#888; text-transform:uppercase; font-size:11px; letter-spacing:2px; font-weight:700; margin-bottom:10px;">Project Date</h4>
            <p style="font-size:14px; color:#ccc;">${p.Fecha}</p>
          </div>
          <div class="project-detail-item mb-4">
            <h4 style="color:#888; text-transform:uppercase; font-size:11px; letter-spacing:2px; font-weight:700; margin-bottom:10px;">Client</h4>
            <p style="font-size:14px; color:#ccc;">${p.Cliente}</p>
          </div>
        </div>
      </div>
    </div>`;
  
  holder.style.display = 'block';
  window.scrollTo({ top: holder.offsetTop - 50, behavior: 'smooth' });
}

// Lógica para cerrar y regresar al portafolio
function closeDynamicProject() {
  const holder = document.getElementById('portfolio-single-holder');
  const wrapper = document.querySelector('.portfolio-wrapper');
  
  holder.style.display = 'none';
  holder.innerHTML = "";
  
  // Reaparece la cuadrícula con su distribución original
  wrapper.style.display = 'block';
}
</script>
